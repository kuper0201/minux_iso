#!/bin/bash
set -euo pipefail

echo "Checking network..."
HOST="8.8.8.8"
PING_COUNT=2

if ! ping -c "$PING_COUNT" "$HOST" >/dev/null 2>&1; then
  echo -e "\nMINUX installer requires an active network connection."
  echo "ðŸ”Œ Please check your connection and try again."
  exit 1
fi

echo "Network OK. Starting MINUX installation..."

archinstall --config /usr/share/minux.json || {
  echo "archinstall failed. Exiting..."
  exit 1
}

echo "Detecting installation device and partitions..."

CONFIG_PATH="/var/log/archinstall/user_configuration.json"
if [[ ! -f "$CONFIG_PATH" ]]; then
  echo "$CONFIG_PATH not found."
  exit 1
fi

INSTALL_DISK="$(jq -r '.disk_config.device_modifications[0].device // empty' "$CONFIG_PATH")"
if [[ -z "$INSTALL_DISK" || ! -b "$INSTALL_DISK" ]]; then
  echo "Install disk not found or not a block device in config: '$INSTALL_DISK'"
  exit 1
fi

# ë””ìŠ¤í¬ëª…ì´ ìˆ«ìžë¡œ ëë‚˜ë©´(p í•„ìš”): nvme0n1, mmcblk0, loop0 ...
# ìˆ«ìžë¡œ ëë‚˜ì§€ ì•Šìœ¼ë©´(p ë¶ˆí•„ìš”): sda, vda ...
part_path() {
  local disk="$1"
  local idx="$2"
  if [[ "$disk" =~ [0-9]$ ]]; then
    echo "${disk}p${idx}"
  else
    echo "${disk}${idx}"
  fi
}

# configì—ì„œ íŠ¹ì • mountpoint(/, /boot, /boot/efi)ì— í•´ë‹¹í•˜ëŠ” íŒŒí‹°ì…˜ ê°ì²´ 1ê°œ ê°€ì ¸ì˜¤ê¸°
part_obj_by_mountpoint() {
  local mp="$1"
  jq -c --arg mp "$mp" '
    .disk_config.device_modifications[0].partitions[]
    | select(.mountpoint == $mp)
  ' "$CONFIG_PATH" | head -n 1
}

# mountpointë¡œ íŒŒí‹°ì…˜ ë””ë°”ì´ìŠ¤ ê²½ë¡œë¥¼ "ì •í™•í•˜ê²Œ" í•´ì„:
# 1) configì— /dev/... device/pathê°€ ìžˆìœ¼ë©´ ì‚¬ìš©
# 2) PARTUUIDê°€ ìžˆìœ¼ë©´ /dev/disk/by-partuuid ë¡œ resolve
# 3) UUIDê°€ ìžˆìœ¼ë©´ /dev/disk/by-uuid ë¡œ resolve
# 4) ìµœí›„ ìˆ˜ë‹¨: partitions ë°°ì—´ì—ì„œì˜ index+1ì„ íŒŒí‹°ì…˜ ë²ˆí˜¸ë¡œ ê°€ì •
resolve_partition_device() {
  local mp="$1"
  local obj
  obj="$(part_obj_by_mountpoint "$mp" || true)"
  [[ -z "$obj" ]] && return 1

  local partuuid uuid devpath

  # archinstall ë²„ì „/í™˜ê²½ì— ë”°ë¼ í‚¤ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆì–´ í›„ë³´ë¥¼ ë‹¤ìˆ˜ ì§€ì›
  devpath="$(echo "$obj" | jq -r '.device // .path // .dev_path // empty')"
  partuuid="$(echo "$obj" | jq -r '.partuuid // .PARTUUID // .part_uuid // empty')"
  uuid="$(echo "$obj" | jq -r '.uuid // .UUID // .fs_uuid // empty')"

  if [[ -n "$devpath" && -b "$devpath" ]]; then
    echo "$devpath"
    return 0
  fi

  if [[ -n "$partuuid" && -e "/dev/disk/by-partuuid/$partuuid" ]]; then
    readlink -f "/dev/disk/by-partuuid/$partuuid"
    return 0
  fi

  if [[ -n "$uuid" && -e "/dev/disk/by-uuid/$uuid" ]]; then
    readlink -f "/dev/disk/by-uuid/$uuid"
    return 0
  fi

  local idx
  idx="$(jq -r --arg mp "$mp" '
    [ .disk_config.device_modifications[0].partitions[].mountpoint ] | index($mp) + 1
  ' "$CONFIG_PATH" 2>/dev/null || true)"

  if [[ -n "$idx" && "$idx" =~ ^[0-9]+$ ]]; then
    local dev
    dev="$(part_path "$INSTALL_DISK" "$idx")"
    if [[ -b "$dev" ]]; then
      echo "$dev"
      return 0
    fi
  fi

  return 1
}

ROOT_PART="$(resolve_partition_device "/")" || {
  echo "Root partition not resolvable from config."
  exit 1
}

BOOT_PART="$(resolve_partition_device "/boot" || true)"
EFI_PART="$(resolve_partition_device "/boot/efi" || true)"

echo "Install disk: $INSTALL_DISK"
echo "Root: $ROOT_PART"
echo "Boot: ${BOOT_PART:-(none)}"
echo "EFI : ${EFI_PART:-(none)}"

echo "Mounting installed system..."
mount "$ROOT_PART" /mnt
mkdir -p /mnt/boot /mnt/boot/efi

if [[ -n "${BOOT_PART:-}" ]]; then
  mount "$BOOT_PART" /mnt/boot
fi

if [[ -n "${EFI_PART:-}" ]]; then
  mount "$EFI_PART" /mnt/boot/efi
fi

# í•„ìˆ˜ ì‹œìŠ¤í…œ ë””ë ‰í† ë¦¬ ë§ˆìš´íŠ¸ (rbind + rslave ê¶Œìž¥)
mount --rbind /dev /mnt/dev
mount --make-rslave /mnt/dev
mount --rbind /proc /mnt/proc
mount --make-rslave /mnt/proc
mount --rbind /sys /mnt/sys
mount --make-rslave /mnt/sys

echo "Running setup script inside chroot..."
SCRIPT_DIR="/root/minux_scripts"

arch-chroot /mnt bash -c "
  set -euxo pipefail
  pacman -Syu --noconfirm git
  git clone https://github.com/kuper0201/minux_scripts $SCRIPT_DIR
  cd $SCRIPT_DIR
  ./setup.sh
  rm -rf $SCRIPT_DIR
" |& tee /root/minux_install.log

# eUFS(UFS) ì§€ì›: ì„¤ì¹˜ëœ ì‹œìŠ¤í…œ ë¶€íŒ… ì‹œ ë£¨íŠ¸ ì¸ì‹ìš© mkinitcpio ëª¨ë“ˆ ì¶”ê°€
# í•„ìš” ì‹œ ufshcd ë“± ì¶”ê°€ ëª¨ë“ˆì„ í•¨ê»˜ ë„£ì„ ìˆ˜ ìžˆìŒ (í™˜ê²½ì— ë”°ë¼ ë‹¤ë¦„)
if [[ -f /mnt/etc/mkinitcpio.conf ]]; then
  if ! grep -qE '^\s*MODULES=\(.*\bufs\b' /mnt/etc/mkinitcpio.conf; then
    echo "Adding eUFS (ufs) module to mkinitcpio for installed system..."
    if grep -qE '^\s*MODULES=\(' /mnt/etc/mkinitcpio.conf; then
      sed -i -E 's/^\s*MODULES=\(([^)]*)\)/MODULES=(ufs \1)/' /mnt/etc/mkinitcpio.conf
    else
      echo 'MODULES=(ufs)' >> /mnt/etc/mkinitcpio.conf
    fi
    arch-chroot /mnt mkinitcpio -P
  fi
fi

read -rp $'\nDo you want to enter chroot for manual setting? [y/N]: ' answer
answer=${answer,,}

if [[ "$answer" == "y" || "$answer" == "yes" ]]; then
  arch-chroot /mnt bash
else
  echo "Unmounting system..."
  umount -R /mnt
  echo "All done!"
fi
